import { NextRequest, NextResponse } from 'next/server'
import { aiChatMessageSchema } from '@/schemas/validation'
import { logger } from '@/lib/logger'
import { createApiResponse, ApiError } from '@/lib/errors'
import { rateLimitCheck } from '@/lib/middleware/rate-limit'
import { config } from '@/lib/config'

export async function POST(request: NextRequest) {
  const requestId = request.headers.get('x-request-id') || crypto.randomUUID()
  const startTime = Date.now()

  try {
    // Rate limiting
    const rateLimitResult = await rateLimitCheck(request, {
      windowMs: 60 * 1000, // 1 minute
      maxRequests: 10, // 10 requests per minute for chat
    })

    if (!rateLimitResult.allowed) {
      throw new ApiError('Rate limit exceeded', 429, 'RATE_LIMIT_EXCEEDED', {
        retryAfter: rateLimitResult.retryAfter
      })
    }

    // Validate request body
    const body = await request.json()
    const validatedData = aiChatMessageSchema.parse(body)
    const { message, conversationHistory = [], clientPreferences, context } = validatedData

    logger.info('Chat request received', {
      requestId,
      messageLength: message.length,
      historyLength: conversationHistory.length,
      context,
      clientPreferences: clientPreferences ? Object.keys(clientPreferences) : []
    })

    // Check if AI service is configured
    const hasAiService = !!(config.GROQ_API_KEY || config.OPENAI_API_KEY || config.GOOGLE_GEMINI_API_KEY)
    
    if (!hasAiService) {
      logger.warn('No AI service configured, using demo mode', { requestId })
      const demoResponse = getDemoResponse(message, conversationHistory)
      
      return createApiResponse({
        response: demoResponse,
        isDemo: true,
        context: 'demo_mode'
      }, {
        requestId,
        processingTime: Date.now() - startTime
      })
    }

    // Generate AI response
    const aiResponse = await generateAiResponse({
      message,
      conversationHistory,
      clientPreferences,
      context,
      requestId
    })

    logger.info('Chat response generated successfully', {
      requestId,
      responseLength: aiResponse.length,
      processingTime: Date.now() - startTime
    })

    return createApiResponse({
      response: aiResponse,
      isDemo: false,
      conversationId: crypto.randomUUID(), // For future conversation tracking
      suggestedActions: generateSuggestedActions(context, message)
    }, {
      requestId,
      processingTime: Date.now() - startTime
    })

  } catch (error) {
    logger.error('Chat API error', {
      error: error instanceof Error ? error.message : 'Unknown error',
      stack: error instanceof Error ? error.stack : undefined,
      requestId,
      processingTime: Date.now() - startTime
    })

    if (error instanceof ApiError) {
      return error.toResponse({ requestId })
    }

    if (error instanceof SyntaxError) {
      throw new ApiError('Invalid JSON in request body', 400, 'INVALID_JSON')
    }

    throw new ApiError(
      'Internal server error during chat processing',
      500,
      'CHAT_PROCESSING_ERROR',
      { originalError: error instanceof Error ? error.message : String(error) }
    )
  }
}

async function generateAiResponse({
  message,
  conversationHistory,
  clientPreferences,
  context,
  requestId
}: {
  message: string
  conversationHistory: any[]
  clientPreferences?: any
  context?: string
  requestId: string
}): Promise<string> {
  
  try {
    // Use GROQ if available (fastest and free)
    if (config.GROQ_API_KEY && config.GROQ_API_KEY !== 'placeholder-key') {
      const { generateGroqResponse, TRAVEL_ADVISOR_PROMPT } = await import('@/lib/groq-simple')
      const { extractCitiesFromPrompt, generateDistanceContext } = await import('@/lib/distances')

      // Extract cities and get distance context
      const citiesInMessage = extractCitiesFromPrompt(message)
      const distanceContext = await generateDistanceContext(citiesInMessage)

      // Build conversation context
      let conversationContext = ''
      if (conversationHistory.length > 0) {
        conversationContext = `\n\nCONTEXTE DE LA CONVERSATION PR√âC√âDENTE:\n${conversationHistory.map(msg => 
          `${msg.role === 'user' ? 'Voyageur' : 'Conseiller'}: ${msg.content}`
        ).join('\n')}\n\nNOUVELLE QUESTION DU VOYAGEUR:`
      } else {
        conversationContext = '\n\nPREMI√àRE INTERACTION - Accueille chaleureusement le prospect et pose des questions pour comprendre ses envies de voyage au S√©n√©gal:'
      }

      // Add client preferences context
      let preferencesContext = ''
      if (clientPreferences) {
        const prefs = []
        if (clientPreferences.interests) prefs.push(`Int√©r√™ts: ${clientPreferences.interests.join(', ')}`)
        if (clientPreferences.culturalImmersionLevel) prefs.push(`Niveau d'immersion culturelle: ${clientPreferences.culturalImmersionLevel}`)
        if (clientPreferences.activityLevel) prefs.push(`Niveau d'activit√©: ${clientPreferences.activityLevel}`)
        if (clientPreferences.accommodationPreference) prefs.push(`Pr√©f√©rence h√©bergement: ${clientPreferences.accommodationPreference}`)
        
        if (prefs.length > 0) {
          preferencesContext = `\n\nPR√âF√âRENCES CLIENT CONNUES:\n${prefs.join('\n')}\n`
        }
      }

      // Add context-specific instructions
      let contextInstructions = ''
      if (context) {
        switch (context) {
          case 'initial_inquiry':
            contextInstructions = '\n\nCONTEXTE: Premi√®re prise de contact - Sois accueillant et pose des questions pour d√©couvrir les besoins.'
            break
          case 'preference_gathering':
            contextInstructions = '\n\nCONTEXTE: Collecte des pr√©f√©rences - Pose des questions sp√©cifiques pour affiner les recommandations.'
            break
          case 'itinerary_proposal':
            contextInstructions = '\n\nCONTEXTE: Proposition d\'itin√©raire - Pr√©sente des suggestions concr√®tes bas√©es sur les pr√©f√©rences.'
            break
          case 'practical_details':
            contextInstructions = '\n\nCONTEXTE: D√©tails pratiques - Fournis des informations pr√©cises sur logistique, prix, r√©servations.'
            break
          case 'modification_request':
            contextInstructions = '\n\nCONTEXTE: Demande de modification - Adapte les suggestions selon les nouvelles exigences.'
            break
          case 'booking_confirmation':
            contextInstructions = '\n\nCONTEXTE: Confirmation de r√©servation - Guide vers la finalisation de la r√©servation.'
            break
        }
      }

      const fullPrompt = `${TRAVEL_ADVISOR_PROMPT}${distanceContext}${preferencesContext}${contextInstructions}

${conversationContext}
"${message}"

IMPORTANT : R√©ponds UNIQUEMENT avec du texte conversationnel. JAMAIS de JSON, code, ou structure technique. Comme si tu parlais √† un ami au t√©l√©phone.`

      const response = await generateGroqResponse(fullPrompt)
      
      logger.info('GROQ response generated', { 
        requestId, 
        responseLength: response.length,
        citiesExtracted: citiesInMessage.length,
        hasPreferences: !!clientPreferences,
        context
      })
      
      return response
    }

    // Fallback to OpenAI if available
    if (config.OPENAI_API_KEY) {
      // Implement OpenAI integration here
      logger.warn('OpenAI fallback not implemented yet', { requestId })
    }

    // Fallback to Gemini if available
    if (config.GOOGLE_GEMINI_API_KEY) {
      // Implement Gemini integration here
      logger.warn('Gemini fallback not implemented yet', { requestId })
    }

    throw new ApiError('No AI service available', 503, 'AI_SERVICE_UNAVAILABLE')

  } catch (error) {
    logger.error('AI response generation failed', {
      error: error instanceof Error ? error.message : 'Unknown error',
      requestId
    })
    throw error
  }
}

function generateSuggestedActions(context?: string, message?: string): string[] {
  const actions = []

  if (!context || context === 'initial_inquiry') {
    actions.push('Parlez-moi de vos pr√©f√©rences de voyage')
    actions.push('Quel est votre budget approximatif ?')
    actions.push('Combien de temps souhaitez-vous rester ?')
  }

  if (context === 'preference_gathering') {
    actions.push('Montrez-moi des suggestions d\'itin√©raires')
    actions.push('Quels sont les h√©bergements recommand√©s ?')
    actions.push('Parlez-moi des activit√©s disponibles')
  }

  if (context === 'itinerary_proposal') {
    actions.push('Modifiez cet itin√©raire selon mes pr√©f√©rences')
    actions.push('Quel est le prix total de ce voyage ?')
    actions.push('Comment puis-je r√©server ?')
  }

  return actions
}

// Demo response function (kept from original)
function getDemoResponse(message: string, history: unknown[]): string {
  const msg = message.toLowerCase()
  
  // Premier message ou salutation
  if (history.length === 0 || msg.includes('bonjour') || msg.includes('salut')) {
    return `üåç Bonjour et bienvenue ! Je suis votre conseiller voyage sp√©cialis√© au S√©n√©gal üá∏üá≥

Je suis ravi de vous aider √† planifier votre d√©couverte de notre magnifique pays !

Pour vous proposer l'itin√©raire parfait, j'aimerais en savoir plus sur vos envies :

üóìÔ∏è **Combien de temps** souhaitez-vous rester au S√©n√©gal ?
üí∞ **Quel est votre budget** approximatif pour ce voyage ?
üéØ **Qu'est-ce qui vous attire le plus** : plages paradisiaques, culture et histoire, safari et nature, ou d√©couverte des villes ?

Dites-moi tout, je vais cr√©er un programme sur-mesure pour vous ! ‚ú®`
  }

  // Budget mentionn√©
  if (msg.includes('budget') || msg.includes('euro') || msg.includes('‚Ç¨') || msg.includes('cher')) {
    return `Parfait ! üí° Avec ces informations sur votre budget, je peux d√©j√† vous orienter :

**GAMMES DE PRIX AU S√âN√âGAL :**
üè® H√©bergement : 25-300‚Ç¨/nuit selon standing
üöó Transport priv√© : 50-150‚Ç¨/jour avec chauffeur  
üçΩÔ∏è Restauration : 5-50‚Ç¨/repas selon lieu
üé≠ Activit√©s : 10-100‚Ç¨ selon type

**MES SUGGESTIONS selon votre budget :**
- **√âconomique** : Cases d'h√¥tes, transports en commun, restaurants locaux
- **Confort** : H√¥tels 3-4‚≠ê, chauffeur priv√©, mix exp√©riences  
- **Premium** : Lodges de luxe, guide priv√©, exp√©riences VIP

Et c√¥t√© **dur√©e**, vous pensez √† combien de temps ? 
Cela m'aiderait aussi √† savoir ce qui vous fait le plus r√™ver : **mer, culture, nature ou aventure** ? üåäüèõÔ∏èüåø`
  }

  // Dur√©e mentionn√©e
  if (msg.includes('jour') || msg.includes('semaine') || msg.includes('temps')) {
    return `Excellent ! ‚è∞ Cette dur√©e nous laisse de belles possibilit√©s !

**VOICI MES RECOMMANDATIONS SELON LE TEMPS :**

**üóìÔ∏è 3-5 JOURS** : Focus Dakar + √éle de Gor√©e + Lac Rose
**üìÖ 1 SEMAINE** : Dakar + Saint-Louis + plages de Saly  
**üóìÔ∏è 2 SEMAINES** : Grand tour avec Casamance ou Niokolo-Koba
**üìÖ 3+ SEMAINES** : Immersion totale multi-r√©gions

**ü§î Pour affiner mes suggestions :**
- √ätes-vous plut√¥t **d√©tente** ou **d√©couverte active** ?
- Voyagez-vous **en couple, famille, entre amis** ou **solo** ?
- Des **incontournables** en t√™te (Gor√©e, plages, safari...) ?

Plus vous me parlez de vos envies, plus mon programme sera parfait ! üéØ`
  }

  // Int√©r√™ts/activit√©s
  if (msg.includes('plage') || msg.includes('mer') || msg.includes('culture') || msg.includes('histoire') || msg.includes('nature') || msg.includes('safari')) {
    return `üéØ Parfait ! Je vois d√©j√† se dessiner votre voyage id√©al !

**SELON VOS GO√õTS, voici mes p√©pites :**

üèñÔ∏è **C√îT√â MER** : Cap Skirring (plages paradisiaques), Saly (animations), Popenguine (nature)

üèõÔ∏è **CULTURE & HISTOIRE** : √éle de Gor√©e (√©mouvant), Saint-Louis (UNESCO), village traditionnel de Toubacouta

üåø **NATURE & SAFARI** : Niokolo-Koba (lions, hippopotames), Djoudj (oiseaux migrateurs), mangroves de Casamance

**üó∫Ô∏è ITIN√âRAIRE RECOMMAND√â :**
Jour 1-2 : Arriv√©e Dakar + Gor√©e
Jour 3-4 : Saint-Louis + culture wolof  
Jour 5-7 : Casamance ou Saly selon pr√©f√©rence

**Une question importante :** pr√©f√©rez-vous un **rythme tranquille** (2-3 lieux max) ou **itin√©rant** (d√©couvrir un maximum) ?

Dites-moi "GO" quand vous voulez que je finalise votre programme complet ! üöÄ`
  }

  // Mot-cl√© "go" d√©tect√©
  if (msg.includes('go') || msg.includes('parfait') || msg.includes('valide')) {
    return `üéâ **VOTRE VOYAGE AU S√âN√âGAL EST PR√äT !**

**üìã R√âCAPITULATIF PERSONNALIS√â :**

**üóìÔ∏è PROGRAMME :**
‚Ä¢ **Jour 1-2** : Dakar (March√© Sandaga, Monument Renaissance) + √éle de Gor√©e  
‚Ä¢ **Jour 3-4** : Saint-Louis (ville coloniale, balade en cal√®che)
‚Ä¢ **Jour 5-6** : Lac Rose + villages traditionnels
‚Ä¢ **Jour 7** : Saly (d√©tente plage, d√©part)

**üöó TRANSPORT :** Chauffeur priv√© francophone (4x4 climatis√©)
**üè® H√âBERGEMENT :** Mix h√¥tels charme + case traditionnelle  
**üçΩÔ∏è RESTAURATION :** D√©couverte gastronomie locale + restaurants s√©lectionn√©s

**üí∞ BUDGET ESTIM√â :** 800-1200‚Ç¨/personne (selon options)

**üì± PR√äT √Ä R√âSERVER ?**
Cliquez sur "Envoyer via WhatsApp" pour recevoir le programme d√©taill√© et discuter des modalit√©s avec notre √©quipe ! 

Votre aventure s√©n√©galaise vous attend ! üá∏üá≥‚ú®`
  }

  // R√©ponse g√©n√©rique
  return `Je comprends ! üòä 

Pour vous conseiller au mieux sur votre voyage au S√©n√©gal, parlez-moi de :
- üóìÔ∏è **Dur√©e souhait√©e** du s√©jour  
- üí∞ **Budget approximatif** 
- üéØ **Ce qui vous attire** le plus (plages, culture, nature...)
- üë• **Avec qui** vous voyagez

Plus j'en sais, plus mes recommandations seront pr√©cises ! 

N'h√©sitez pas √† me dire "GO" quand vous voulez que je finalise votre programme personnalis√© ! üöÄ`
}